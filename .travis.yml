dist: xenial
language: python
cache: pip

stages:
  - "test Linux"
  - "test macOS"
  - "test Windows"

services:
  - postgresql

env:
  global:
    - V=1
    - QUIET=

install:
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install make python; fi
  - "make install-codecov"
  - "make upgrade-wheel"
  - "make install-test"

before_script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then psql -c 'create database travis_ci_test;' -U postgres; fi

jobs:
  allow_failures:
    - os: windows

  include:
    - stage: "test Linux"
      name: "Python 2.7"
      python: "2.7"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "Python 3.4"
      python: "3.4"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "Python 3.5"
      python: "3.5"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "Python 3.6"
      python: "3.6"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "Python 3.7"
      python: "3.7"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "Python 3.8"
      python: "3.8-dev"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "PyPy2"
      python: "pypy"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "PyPy3"
      python: "pypy3"
      script:
        - "make test"
        - "make test-postgresql"
        - "make test-in-memory"
    - stage: "test Linux"
      name: "lint python3"
      python: "3.7"
      script:
        - "make lint"

    - stage: "test macOS"
      name: "Python 2.7"
      os: osx
      osx_image: xcode10
      language: shell
      script:
        - "make test"
        - "make test-in-memory"
    - stage: "test macOS"
      name: "Python 3.7"
      os: osx
      osx_image: xcode10
      language: shell
      env:
        - PYTHON=python3
        - V=1
        - QUIET=
      script:
        - "make test"
        - "make test-in-memory"

    - stage: "test Windows"
      name: "Python 3.7"
      os: windows
      language: shell
      script:
        - "make test"
        - "make test-in-memory"

after_success:
  - codecov
